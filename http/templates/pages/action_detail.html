{{ define "content" }}
<h2>Action Detail</h2>

<div class="card mb-4">
	<div class="card-body">
		<h5 class="card-title">Action Info</h5>
		<div><strong>ID:</strong> <span id="action-id"></span></div>
		<div><strong>Name:</strong> <span id="action-name"></span></div>
		<div><strong>Command:</strong> <span id="action-command"></span></div>
	</div>
</div>

<div class="mb-3">
	<a href="{{.AppRoot}}action" class="btn btn-sm btn-outline-secondary">&larr; Back</a>
	<button class="btn btn-success me-2" onclick="restartAction()">Restart</button>
	<button class="btn btn-warning" onclick="cancelAction()">Cancel</button>
</div>

<ul class="nav nav-tabs mb-3" id="actionTabs" role="tablist">
	<li class="nav-item" role="presentation">
		<button class="nav-link active" id="queue-tab" data-bs-toggle="tab" data-bs-target="#queue" type="button" role="tab">Queue</button>
	</li>
	<li class="nav-item" role="presentation">
		<button class="nav-link" id="dlq-tab" data-bs-toggle="tab" data-bs-target="#dlq" type="button" role="tab">DLQ</button>
	</li>
</ul>

<div class="tab-content" id="actionTabContent">
	<div class="tab-pane fade show active" id="queue" role="tabpanel">
		<ul class="list-group" id="queueList"></ul>
	</div>
	<div class="tab-pane fade" id="dlq" role="tabpanel">
		<div class="mb-2">
			<button class="btn btn-sm btn-danger me-2" onclick="bulkDeleteDLQ()">Delete Selected</button>
			<button class="btn btn-sm btn-secondary" onclick="bulkRedriveDLQ()">Redrive Selected</button>
		</div>
		<ul class="list-group" id="dlqList"></ul>
	</div>
</div>

<!-- Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="detailModalLabel">Message Detail</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body" id="modalContent"></div>
		</div>
	</div>
</div>
{{ end }}

{{ define "scripts" }}
<script>
	const actionId = window.location.pathname.split('/').pop();

	function fetchAction() {
		fetch('../api/action')
			.then(res => res.json())
			.then(data => {
				const action = data.find(a => a.id === actionId);
				if (!action) return alert("Action not found.");
				document.getElementById('action-id').textContent = action.id;
				document.getElementById('action-name').textContent = action.name;
				document.getElementById('action-command').textContent = action.command;
			});
	}

	function restartAction() {
		fetch(`../api/action/${actionId}/restart`, { method: 'POST' })
			.then(res => alert(res.ok ? "Restarted." : "Restart failed."));
	}

	function cancelAction() {
		fetch(`../api/action/${actionId}/cancel`, { method: 'POST' })
			.then(res => alert(res.ok ? "Cancelled." : "Cancel failed."));
	}

	function fetchQueue() {
		fetch(`../api/action/${actionId}/queue`)
			.then(res => res.json())
			.then(data => {
				const list = document.getElementById('queueList');
				list.innerHTML = '';
				data.forEach(item => {
					const li = document.createElement('li');
					li.className = 'list-group-item d-flex justify-content-between align-items-center';

					const title = document.createElement('span');
					title.innerText = item.title || '(no title)';

					const buttonGroup = document.createElement('div');
					const viewBtn = document.createElement('button');
					viewBtn.className = 'btn btn-sm btn-outline-info me-1';
					viewBtn.innerText = '詳細を表示';
					viewBtn.onclick = () => showModal(item);

					const delBtn = document.createElement('button');
					delBtn.className = 'btn btn-sm btn-outline-danger';
					delBtn.innerText = 'Delete';
					delBtn.onclick = () => deleteQueueMessage(item.id);

					buttonGroup.appendChild(viewBtn);
					buttonGroup.appendChild(delBtn);

					li.appendChild(title);
					li.appendChild(buttonGroup);
					list.appendChild(li);
				});
			});
	}

	function fetchDLQ() {
		fetch(`../api/action/${actionId}/dlqueue`)
			.then(res => res.json())
			.then(data => {
				const list = document.getElementById('dlqList');
				list.innerHTML = '';
				data.forEach(item => {
					const li = document.createElement('li');
					li.className = 'list-group-item d-flex justify-content-between align-items-center';

					const left = document.createElement('div');
					left.className = 'd-flex align-items-center';

					const checkbox = document.createElement('input');
					checkbox.type = 'checkbox';
					checkbox.className = 'form-check-input dlq-checkbox me-2';
					checkbox.value = item.id;

					const title = document.createElement('span');
					title.innerText = item.title || '(no title)';

					left.appendChild(checkbox);
					left.appendChild(title);

					const viewBtn = document.createElement('button');
					viewBtn.className = 'btn btn-sm btn-outline-info';
					viewBtn.innerText = '詳細を表示';
					viewBtn.onclick = () => showModal(item);

					li.appendChild(left);
					li.appendChild(viewBtn);
					list.appendChild(li);
				});
			});
	}

	function deleteQueueMessage(id) {
		if (!confirm("Delete this queue message?")) return;
		fetch(`../api/action/${actionId}/queue/${id}`, { method: 'DELETE' })
			.then(res => {
				if (res.ok) fetchQueue();
				else alert("Failed to delete queue message.");
			});
	}

	function bulkDeleteDLQ() {
		const ids = getSelectedDLQIds();
		if (ids.length === 0) return alert("No messages selected.");
		if (!confirm(`Delete ${ids.length} message(s)?`)) return;

		Promise.all(ids.map(id =>
			fetch(`../api/action/${actionId}/dlqueue/${id}`, { method: 'DELETE' })
		)).then(fetchDLQ);
	}

	function bulkRedriveDLQ() {
		const ids = getSelectedDLQIds();
		if (ids.length === 0) return alert("No messages selected.");
		if (!confirm(`Redrive ${ids.length} message(s)?`)) return;

		Promise.all(ids.map(id =>
			fetch(`../api/action/${actionId}/dlqueue/${id}/redrive`, { method: 'POST' })
			)).then(() => {
				location.reload();
			});
			}

				function getSelectedDLQIds() {
					return Array.from(document.querySelectorAll('.dlq-checkbox:checked')).map(cb => cb.value);
				}

				function showModal(item) {
					const modalBody = document.getElementById('modalContent');
					modalBody.innerHTML = `
						<div><strong>Title:</strong> ${item.title}</div>
						<div><strong>Body:</strong> <pre>${item.body || ''}</pre></div>
							<div><strong>Link:</strong> <a href="${item.link}" target="_blank">${item.link}</a></div>
							<div><strong>Timestamp:</strong> ${new Date(item.timestamp * 1000).toLocaleString()}</div>
							<div><strong>Source ID:</strong> ${item.src?.id || ''}</div>
							<div><strong>Raw:</strong><pre>${item.raw || ''}</pre></div>
								`;
								const modal = new bootstrap.Modal(document.getElementById('detailModal'));
								modal.show();
								}

								document.addEventListener('DOMContentLoaded', () => {
								fetchAction();
								fetchQueue();
								fetchDLQ();
								});
</script>
{{ end }}

{{ define "contents" }}
{{ template "layout" . }}
{{ end }}

