{{ define "content" }}
<h2>Sources</h2>

<div class="card mb-4">
	<div class="card-body">
		<h5 class="card-title">Add New Source</h5>
		<div class="row g-2">
			<div class="col-md-4">
				<input type="text" id="title" class="form-control" placeholder="Title">
			</div>
			<div class="col-md-4">
				<input type="text" id="value" class="form-control" placeholder="Value (e.g. URL)">
			</div>
			<div class="col-md-3">
				<select id="type" class="form-select"></select>
			</div>
			<div class="col-md-1">
				<button onclick="addSource()" class="btn btn-primary w-100">Add</button>
			</div>
		</div>
	</div>
</div>

<div class="table-responsive">
	<table class="table table-bordered table-hover" id="sourcesTable">
		<thead class="table-dark">
			<tr>
				<th id="th-id" onclick="sortTable('id')" style="cursor:pointer">ID</th>
				<th>Feed</th>
				<th id="th-title" onclick="sortTable('title')" style="cursor:pointer">Name</th>
				<th id="th-value" onclick="sortTable('value')" style="cursor:pointer">Value</th>
				<th id="th-type" onclick="sortTable('type')" style="cursor:pointer">Type</th>
				<th id="th-pause" onclick="sortTable('pause')" style="cursor:pointer">Pause</th>
				<th>Action</th>
			</tr>
		</thead>
		<tbody id="sourcesTableBody"></tbody>
	</table>
</div>
{{ end }}

{{ define "scripts" }}
<script>
	let sourcesData = [];
	let currentSort = { column: null, ascending: true };

	function fetchSourceTypes() {
		fetch('./api/source_type')
			.then(res => res.json())
			.then(data => {
				const select = document.getElementById('type');
				select.innerHTML = '';
				data.forEach(type => {
					const option = document.createElement('option');
					option.value = type.id;
					option.textContent = type.name + (type.user_create ? '' : ' (system)');
					if (type.name === 'rss') option.selected = true;
					select.appendChild(option);
				});
			})
			.catch(err => console.error('Error fetching types:', err));
	}

	function fetchSources() {
		fetch('./api/source')
			.then(res => res.json())
			.then(data => {
				sourcesData = data;
				renderTable();
				updateSortIcons();
			})
			.catch(err => console.error('Error fetching sources:', err));
	}

	function renderTable() {
		const body = document.getElementById('sourcesTableBody');
		body.innerHTML = '';
		sourcesData.forEach(source => {
			const row = document.createElement('tr');
			row.innerHTML = `
		<td><a href="./source/${source.id}">${source.id}</a></td>
		<td><a href="./api/feed/${source.id}" target="_blank">feed</a></td>
		<td>${source.title}</td>
		<td>${source.value}</td>
		<td>${source.type.name}</td>
		<td>${source.pause}</td>
		<td>
		  <button class="btn btn-sm btn-danger" onclick="deleteSource('${source.id}')">Delete</button>
		</td>
	  `;
			body.appendChild(row);
		});
	}

	function sortTable(column) {
		if (currentSort.column === column) {
			currentSort.ascending = !currentSort.ascending;
		} else {
			currentSort.column = column;
			currentSort.ascending = true;
		}

		sourcesData.sort((a, b) => {
			let valA, valB;

			switch (column) {
				case 'id':
					valA = a.id; valB = b.id; break;
				case 'title':
					valA = a.title.toLowerCase(); valB = b.title.toLowerCase(); break;
				case 'value':
					valA = a.value.toLowerCase(); valB = b.value.toLowerCase(); break;
				case 'type':
					valA = a.type.name.toLowerCase(); valB = b.type.name.toLowerCase(); break;
				case 'pause':
					valA = String(a.pause).toLowerCase(); valB = String(b.pause).toLowerCase(); break;
				default:
					return 0;
			}

			if (valA < valB) return currentSort.ascending ? -1 : 1;
			if (valA > valB) return currentSort.ascending ? 1 : -1;
			return 0;
		});

		renderTable();
		updateSortIcons();
	}

	function updateSortIcons() {
		const columns = {
			id: 'ID',
			title: 'Name',
			value: 'Value',
			type: 'Type',
			pause: 'Pause'
		};

		for (const col in columns) {
			const th = document.getElementById(`th-${col}`);
			if (currentSort.column === col) {
				th.innerText = `${columns[col]} ${currentSort.ascending ? '▲' : '▼'}`;
			} else {
				th.innerText = columns[col];
			}
		}
	}

	function addSource() {
		const title = document.getElementById('title').value.trim();
		const value = document.getElementById('value').value.trim();
		const type_id = document.getElementById('type').value;

		if (!title || !value) {
			alert("Title and Value are required.");
			return;
		}

		fetch('./api/source', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ title, value, type: { id: type_id } })
		})
			.then(res => {
				if (res.ok) {
					fetchSources();
					document.getElementById('title').value = '';
					document.getElementById('value').value = '';
				} else {
					alert("Failed to add source.");
					console.error('Add failed', res);
				}
			})
			.catch(err => {
				alert("Error adding source.");
				console.error('Error:', err);
			});
	}

	function deleteSource(id) {
		if (!confirm("Are you sure you want to delete this source?")) return;

		fetch('./api/source', {
			method: 'DELETE',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ id })
		})
			.then(res => {
				if (res.ok) {
					fetchSources();
				} else {
					alert("Failed to delete source.");
					console.error('Delete failed', res);
				}
			})
			.catch(err => {
				alert("Error deleting source.");
				console.error('Error:', err);
			});
	}

	document.addEventListener('DOMContentLoaded', function () {
		fetchSourceTypes();
		fetchSources();
	});
</script>
{{ end }}

{{define "contents"}}
	{{ template "layout" . }}
{{ end }}
