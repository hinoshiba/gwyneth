{{ define "content" }}
<h3 class="mb-3">Add New Source</h3>
<div class="row mb-4">
	<div class="col-md-3">
		<input type="text" id="title" class="form-control form-control-sm" placeholder="Title">
	</div>
	<div class="col-md-3">
		<input type="text" id="value" class="form-control form-control-sm" placeholder="Value">
	</div>
	<div class="col-md-3">
		<select id="type" class="form-select form-select-sm"></select>
	</div>
	<div class="col-md-3">
		<button class="btn btn-sm btn-primary w-100" onclick="addSource()">Add Source</button>
	</div>
</div>

<h2 class="mb-3">Sources</h2>
<div class="d-flex justify-content-between align-items-center mb-3">
	<div>
		<label for="itemsPerPage" class="me-2">表示件数:</label>
		<select id="itemsPerPage" class="form-select d-inline-block w-auto form-select-sm">
			<option value="5">5</option>
			<option value="10">10</option>
			<option value="25" selected>25</option>
			<option value="50">50</option>
			<option value="100">100</option>
		</select>
	</div>
	<div id="paginationControls" class="btn-group"></div>
</div>

<table class="table table-bordered table-sm">
	<thead class="table-dark">
		<tr>
			<th>Feed</th>
			<th onclick="sortTableBy('title')" style="cursor:pointer">Name <span id="sortIcon-title"></span></th>
			<th onclick="sortTableBy('value')" style="cursor:pointer">Value <span id="sortIcon-value"></span></th>
			<th onclick="sortTableBy('type')" style="cursor:pointer">Type <span id="sortIcon-type"></span></th>
			<th>Collection</th>
			<th>Latest Result</th>
			<th>Action</th>
		</tr>
	</thead>
	<tbody id="sourcesTableBody"></tbody>
</table>
<style>
#sourcesTableBody tr:hover {
	background-color: #f1f1f1;
}
</style>
{{ end }}

{{ define "scripts" }}
<script>
	let allSources = [];
	let currentPage = 1;
	let itemsPerPage = 25;
	let sortKey = null;
	let sortAsc = true;

	function sortTableBy(key) {
		if (sortKey === key) {
			sortAsc = !sortAsc;
		} else {
			sortKey = key;
			sortAsc = true;
		}

		allSources.sort((a, b) => {
			const valA = a[key]?.toLowerCase?.() || a[key]?.name?.toLowerCase?.() || '';
			const valB = b[key]?.toLowerCase?.() || b[key]?.name?.toLowerCase?.() || '';
			return sortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
		});

		document.querySelectorAll("span[id^='sortIcon-']").forEach(e => e.innerHTML = '');
		document.getElementById(`sortIcon-${key}`).innerHTML = sortAsc ? '▲' : '▼';

		paginateSources();
	}

	function paginateSources() {
		const start = (currentPage - 1) * itemsPerPage;
		const end = start + itemsPerPage;
		const visibleSources = allSources.slice(start, end);

		const tbody = document.getElementById('sourcesTableBody');
		tbody.innerHTML = '';

		visibleSources.forEach(source => {
			const row = document.createElement('tr');
			row.style.cursor = 'pointer';
			row.onclick = (e) => {
				if (e.target.closest('button') || e.target.tagName.toLowerCase() === 'a') return;
				window.location.href = `./source/${source.id}`;
			};

			const statusColor = source.pause ? 'danger' : 'success';
			const statusLabel = source.pause ? 'Paused' : 'Running';
			const latestResult = source.status && source.status.length > 0
				? `<span class="badge bg-${source.status[0].success ? 'primary' : 'danger'}">${source.status[0].success ? 'Success' : 'Failed'}</span>`
				: '-';

			const feedButton = `<a href="./api/feed/${source.id}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-warning"><i class="bi bi-rss"></i> RSS</a>`;
			const typeLabel = source.type.name === 'rss'
				? '<span class="badge bg-info text-dark">rss</span>'
				: '<span class="badge bg-secondary">noop</span>';

			row.innerHTML = `
	  <td>${feedButton}</td>
	  <td>${source.title}</td>
	  <td>${source.value}</td>
	  <td>${typeLabel}</td>
	  <td><span class="badge bg-${statusColor}">${statusLabel}</span></td>
	  <td>${latestResult}</td>
	  <td><button class="btn btn-sm btn-outline-secondary" onclick="deleteSource('${source.id}')">Delete</button></td>
	`;
			tbody.appendChild(row);
		});

		renderPaginationControls();
	}

	function renderPaginationControls() {
		const pageCount = Math.ceil(allSources.length / itemsPerPage);
		const container = document.getElementById('paginationControls');
		container.innerHTML = '';

		for (let i = 1; i <= pageCount; i++) {
			const btn = document.createElement('button');
			btn.className = `btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'}`;
			btn.innerText = i;
			btn.onclick = () => {
				currentPage = i;
				paginateSources();
			};
			container.appendChild(btn);
		}
	}

	function fetchSourceTypes() {
		fetch('./api/source_type')
			.then(res => res.json())
			.then(data => {
				const typeSelect = document.getElementById('type');
				typeSelect.innerHTML = '';
				data.forEach(t => {
					const opt = document.createElement('option');
					opt.value = t.id;
					opt.textContent = t.name + (t.user_create ? '' : ' (system)');
					if (t.name === 'noop') opt.selected = true;
					typeSelect.appendChild(opt);
				});
			});
	}

	function addSource() {
		const title = document.getElementById('title').value;
		const value = document.getElementById('value').value;
		const type_id = document.getElementById('type').value;

		fetch('./api/source', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ title, value, type: { id: type_id } })
		})
			.then(res => {
				if (res.ok) {
					document.getElementById('title').value = '';
					document.getElementById('value').value = '';
					fetchSources();
				} else {
					alert('Failed to add source');
				}
			})
			.catch(err => console.error('Error adding source:', err));
	}

	function fetchSources() {
		fetch('./api/source')
			.then(res => res.json())
			.then(data => {
				allSources = data;
				if (sortKey) sortTableBy(sortKey);
				else paginateSources();
			})
			.catch(err => console.error('Error fetching sources:', err));
	}

	function deleteSource(id) {
		if (!confirm("Are you sure you want to delete?")) return;

		fetch('./api/source', {
			method: 'DELETE',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ id })
		})
			.then(res => {
				if (res.ok) {
					allSources = allSources.filter(s => s.id !== id);
					paginateSources();
				} else {
					console.error('Failed to delete source');
				}
			})
			.catch(err => console.error('Error deleting source:', err));
	}

	document.addEventListener('DOMContentLoaded', () => {
		fetchSourceTypes();
		fetchSources();
		document.getElementById('itemsPerPage').addEventListener('change', function () {
			itemsPerPage = parseInt(this.value);
			currentPage = 1;
			paginateSources();
		});
	});
</script>
{{ end }}

{{define "contents"}}
	{{ template "layout" . }}
{{ end }}
